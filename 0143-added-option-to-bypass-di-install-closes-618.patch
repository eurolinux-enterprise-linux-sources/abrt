From 03bccec30068fbae9648df56a71ee81cfec8cbff Mon Sep 17 00:00:00 2001
From: Jiri Moskovcak <jmoskovc@redhat.com>
Date: Thu, 7 Mar 2013 16:59:08 +0100
Subject: [ABRT EL6 PATCH 143/197] added option to bypass di install closes
 #618

Signed-off-by: Jiri Moskovcak <jmoskovc@redhat.com>
Signed-off-by: Denys Vlasenko <dvlasenk@redhat.com>
---
 src/plugins/abrt-action-analyze-ccpp-local | 31 +++++++++++++++++++++---------
 src/plugins/ccpp_event.conf                |  4 +++-
 2 files changed, 25 insertions(+), 10 deletions(-)

diff --git a/src/plugins/abrt-action-analyze-ccpp-local b/src/plugins/abrt-action-analyze-ccpp-local
index 0c5ab34..fee0db1 100755
--- a/src/plugins/abrt-action-analyze-ccpp-local
+++ b/src/plugins/abrt-action-analyze-ccpp-local
@@ -1,17 +1,30 @@
-#! /bin/sh
-if [ "`id -u`x" == "0x" ]; then
-    abrt-action-analyze-core --core=coredump | abrt-action-install-debuginfo --ids=- --size_mb=4096
-else
-    abrt-action-analyze-core --core=coredump | /usr/libexec/abrt-action-install-debuginfo-to-abrt-cache --ids=- --size_mb=4096
-fi;
+#!/bin/sh
 
-if [ "$?x" == "0x" ]; then
+INSTALL_DI=true
+for opt in "$@"; do
+    if [ x"$opt" = x"--without-di" ]; then
+        INSTALL_DI=false
+    fi;
+done
+if $INSTALL_DI; then
+    # On some systems debuginfo install needs root privileges.
+    # Running a suided-to-abrt wrapper would make
+    # debuginfo install fail even for root.
+    # Therefore, if we are root, we don't use the wrapper.
+    if [ x"`id -u`" = x"0" ]; then
+        abrt-action-analyze-core --core=coredump | abrt-action-install-debuginfo --ids=- --size_mb=4096
+    else
+        abrt-action-analyze-core --core=coredump | /usr/libexec/abrt-action-install-debuginfo-to-abrt-cache --ids=- --size_mb=4096
+    fi
+fi
+
+if [ $? = 0 ]; then
     abrt-action-generate-backtrace &&
     abrt-action-analyze-backtrace &&
     (
-        bug_id=$(reporter-bugzilla -h `cat duphash`) &&
+        bug_id=$(reporter-bugzilla -h "`cat duphash`") &&
         if test -n "$bug_id"; then
             abrt-bodhi -r -b $bug_id
         fi
     )
-fi
\ No newline at end of file
+fi
diff --git a/src/plugins/ccpp_event.conf b/src/plugins/ccpp_event.conf
index bf8e9a5..7bb2c9b 100644
--- a/src/plugins/ccpp_event.conf
+++ b/src/plugins/ccpp_event.conf
@@ -32,7 +32,9 @@ EVENT=collect_xsession_errors analyzer=CCpp dso_list~=.*/libX11.*
 # TODO: can we still specify additional directories to search for debuginfos,
 # or was this ability lost with move to python installer?
 EVENT=analyze_LocalGDB analyzer=CCpp
-        abrt-action-analyze-ccpp-local
+	# debuginfo install is disabled by default on rhel
+	# if you want to enable it, just remove the --without-di
+        abrt-action-analyze-ccpp-local --without-di
 
 
 # Bugzilla requires nonempty duphash
-- 
1.8.2.1

