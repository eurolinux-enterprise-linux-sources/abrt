From 71b2af9f3005cd84ace9f018fb5f738111b348aa Mon Sep 17 00:00:00 2001
From: Jakub Filak <jfilak@redhat.com>
Date: Thu, 9 Oct 2014 10:24:42 +0200
Subject: [ABRT PATCH] ureport: attach contact email if configured

Resolves #1150389

Signed-off-by: Jakub Filak <jfilak@redhat.com>
---
 src/plugins/abrt-action-ureport | 28 +++++++++++++++++++++++++---
 1 file changed, 25 insertions(+), 3 deletions(-)

diff --git a/src/plugins/abrt-action-ureport b/src/plugins/abrt-action-ureport
index 0f6de03..e296e4a 100755
--- a/src/plugins/abrt-action-ureport
+++ b/src/plugins/abrt-action-ureport
@@ -8,16 +8,23 @@
 import sys
 import os
 import getopt
+import re
 
 from report import dd_opendir, DD_FAIL_QUIETLY_ENOENT, run_event_state
 from reportclient import _, set_verbosity, error_msg_and_die, error_msg, log1, log
 
-def spawn_and_wait(prog):
+
+def spawn_and_wait(prog, args=None):
+    if args is None:
+        args = [prog]
+    else:
+        args.insert(0, prog)
+
     try:
-        return os.spawnlp(os.P_WAIT, prog, prog)
+         return os.spawnvpe(os.P_WAIT, prog, args, os.environ)
     except OSError as err:
         error_msg(_("Unable to start '%s', error message was: '%s'"),
-                    prog, err)
+                    " ".join(args), err)
         return -1
 
 def try_parse_number(dd, filename):
@@ -71,6 +78,7 @@ if __name__ == "__main__":
             verbose += 1
 
     set_verbosity(verbose)
+    os.environ["ABRT_VERBOSE"] = str(verbose)
 
     # getcwd might fail if cwd was deleted
     try:
@@ -138,6 +146,20 @@ if __name__ == "__main__":
                 log(_("Adding you to CC List of the existing bugzilla bug"))
                 run_event("watch_Bugzilla", dirname)
 
+        email = os.getenv("uReport_ContactEmail")
+        if not email:
+            cere = re.compile("^\s*ContactEmail\s*=\s*(\S*)\s*$");
+            with open("/etc/libreport/plugins/ureport.conf", "r") as uc:
+                for l in uc:
+                    m = cere.match(l)
+                    if m:
+                        email = m.group(1)
+                        break
+
+        if email:
+            log1("Attaching ContactEmail: " + email)
+            spawn_and_wait("reporter-ureport", ["-A", "-E"])
+
         sys.exit(exitcode)
     else:
         error_msg_and_die(_("reporter-ureport failed with exit code %d" % exitcode))
-- 
1.8.3.1

